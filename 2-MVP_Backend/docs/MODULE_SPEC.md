# Module Specifications: NLP-Atomic-Backend

This document provides detailed specifications for each module within the `2-MVP_Backend` service. It outlines their responsibilities, public interfaces (functions, inputs, and outputs), and any exceptions they might raise. This ensures clarity on module contracts and facilitates future development and maintenance.

## Table of Contents

1.  [Introduction](#1-introduction)
2.  [API Layer (`app.py`)](#2-api-layer-apppy)
3.  [NLP Client (`nlp/llm_client.py`)](#3-nlp-client-nplllm_clientpy)
4.  [Validation Module (`models/commands.py`)](#4-validation-module-modelscommandspy)
5.  [Executor Module](#5-executor-module)
    *   [Structure Executor (`executor/structure.py`)](#51-structure-executor-executorstructurepy)
    *   [View Executor (`executor/view.py`)](#52-view-executor-executorviewpy)
6.  [Utilities (`utils/`)](#6-utilities-utils)
    *   [Error Handlers (`utils/error_handlers.py`)](#61-error-handlers-utilterror_handlerspy)
    *   [Logging (`utils/logging.py`)](#62-logging-utilsloggingpy)

---

## 1. Introduction

The NLP-Atomic-Backend is designed with a modular architecture to ensure clear separation of concerns and maintainability. Each module has a specific role in processing natural language prompts, generating and validating commands, executing atomic structure and view operations, and returning structured results to the frontend.

This document serves as a contract for each module, detailing its public-facing functions, expected inputs, and guaranteed outputs.

---

## 2. API Layer (`app.py`)

**Responsibility:**
The `app.py` module serves as the primary entry point for all external requests. It handles HTTP request parsing, orchestrates the flow of data through the NLP, validation, and execution modules, and formats the final response. It also implements global error handling and CORS policies.

**Public Interface:**

### `POST /api/commands`

Processes a natural language prompt from the frontend, translates it into a sequence of structured commands, executes them, and returns the results.

*   **Endpoint:** `/api/commands`
*   **Method:** `POST`
*   **Inputs:**
    *   **Request Body (JSON):**
        ```json
        {
          "prompt": "string"
        }
        ```
        *   `prompt`: The natural language query from the user (e.g., "build an FCC aluminum structure").
*   **Outputs:**
    *   **Response Body (JSON):** A list of executed commands, each with its original command and parameters, and the result of its execution.
        ```json
        [
          {
            "command": "string",
            "params": { ... }, // Parameters specific to the command
            "result": { ... }  // Result of the command execution (e.g., PDB data, view object)
          }
        ]
        ```
*   **Exceptions:**
    *   `HTTPException (400 Bad Request)`: If the input JSON is malformed or the prompt is missing.
    *   `HTTPException (500 Internal Server Error)`: For unhandled exceptions during NLP processing, command validation, or execution.
    *   `HTTPException (422 Unprocessable Entity)`: If the LLM generates commands that fail schema validation.

---

## 3. NLP Client (`nlp/llm_client.py`)

**Responsibility:**
The `llm_client.py` module is responsible for interacting with the OpenAI ChatCompletion API. It takes a user's natural language prompt, constructs the appropriate API request with function schemas and few-shot examples, and extracts the generated structured JSON commands from the LLM's response.

**Public Interface:**

### `generate_commands_from_prompt(prompt: str) -> List[Dict[str, Any]]`

Sends a user prompt to the LLM and retrieves a list of structured command objects.

*   **Inputs:**
    *   `prompt` (str): The natural language query from the user.
*   **Outputs:**
    *   `List[Dict[str, Any]]`: A list of dictionaries, where each dictionary represents a command generated by the LLM, conforming to the `Command` schema defined in `JSON_SCHEMA.md`.
        ```python
        [
            {
                "command": "buildStructure",
                "params": {
                    "element": "Al",
                    "lattice": "fcc",
                    "nx": 1,
                    "ny": 1,
                    "nz": 1,
                    "format": "pdb"
                }
            },
            {
                "command": "rotateCamera",
                "params": {
                    "axis": "y",
                    "angle": 90
                }
            }
        ]
        ```
*   **Exceptions:**
    *   `OpenAIError`: If there's an issue communicating with the OpenAI API.
    *   `LLMGenerationError`: If the LLM fails to generate valid function calls or the response is malformed.

---

## 4. Validation Module (`models/commands.py`)

**Responsibility:**
The `commands.py` module defines the Pydantic models for all supported commands and their parameters. Its primary role is to validate the structure and content of the JSON commands received from the NLP client, ensuring they conform to predefined schemas.

**Public Interface:**

### `validate_commands(raw_commands: List[Dict[str, Any]]) -> List[Command]`

Validates a list of raw command dictionaries against their respective Pydantic schemas.

*   **Inputs:**
    *   `raw_commands` (List[Dict[str, Any]]): A list of dictionaries, typically received from the NLP client, representing commands and their parameters.
*   **Outputs:**
    *   `List[Command]`: A list of validated Pydantic `Command` objects. Each `Command` object will have a `command` attribute (str) and a `params` attribute (Pydantic model specific to the command).
*   **Exceptions:**
    *   `ValidationError`: If any command or its parameters do not conform to the defined Pydantic schemas. This exception will contain details about the validation failures.

**Pydantic Models (Internal/Schema Reference):**
This module defines various Pydantic models, including:
*   `Command`: The base model for all commands, using `Union` to allow for different `params` types.
*   `BuildStructureParams`: Parameters for the `buildStructure` command.
*   `RotateCameraParams`: Parameters for the `rotateCamera` command.
*   `SetViewParams`: Parameters for the `setView` command.
*   `LoadPdbParams`: Parameters for the `loadPdb` command.
*   `SetRepresentationParams`: Parameters for the `setRepresentation` command.
*   `SetBackgroundColorParams`: Parameters for the `setBackgroundColor` command.
*   `TranslateCameraParams`: Parameters for the `translateCamera` command.
*   `ZoomParams`: Parameters for the `zoom` command.
*   `ResetViewParams`: Parameters for the `resetView` command.
*   `ToggleAxesParams`: Parameters for the `toggleAxes` command.
*   `ToggleUnitCellParams`: Parameters for the `toggleUnitCell` command.
*   `DisplayMessageParams`: Parameters for the `displayMessage` command.
*   `Quaternion`, `Translation`, `ViewObject`, `CrystalData`: Helper models for complex parameter types.

(Refer to [`2-MVP_Backend/docs/JSON_SCHEMA.md`](2-MVP_Backend/docs/JSON_SCHEMA.md) for the complete JSON Schema definitions derived from these models.)

---

## 5. Executor Module

The Executor module is responsible for performing the actual operations requested by the validated commands. It is logically divided into sub-modules based on the type of operation.

### 5.1. Structure Executor (`executor/structure.py`)

**Responsibility:**
The `structure.py` module handles the generation of atomic structures using the Atomic Simulation Environment (ASE) library. It takes structured parameters for building a structure and returns the generated structure data in a specified format.

**Public Interface:**

### `build_structure(params: BuildStructureParams) -> Dict[str, str]`

Generates an atomic structure based on the provided parameters and returns it as a string in the specified format.

*   **Inputs:**
    *   `params` (BuildStructureParams): A Pydantic object containing parameters for structure generation (e.g., `element`, `lattice`, `nx`, `ny`, `nz`, `a`, `format`).
*   **Outputs:**
    *   `Dict[str, str]`: A dictionary containing the generated structure data.
        ```python
        {
          "format": "pdb", // or "xyz", "cif"
          "data": "string" // The PDB/XYZ/CIF file content as a string
        }
        ```
*   **Exceptions:**
    *   `StructureGenerationError`: If ASE fails to generate the structure due to invalid parameters or internal issues.
    *   `ValueError`: If required parameters are missing or have invalid values.

---

### 5.2. View Executor (`executor/view.py`)

**Responsibility:**
The `view.py` module is responsible for computing and manipulating camera and view parameters for the 3D viewer. It takes command-specific parameters and returns updated view objects or related data.

**Public Interface:**

### `compute_rotate_camera(params: RotateCameraParams, current_view: Optional[Dict[str, Any]] = None) -> Dict[str, Any]`

Calculates the new camera orientation after rotation.

*   **Inputs:**
    *   `params` (RotateCameraParams): A Pydantic object containing rotation parameters (`axis`, `angle`).
    *   `current_view` (Optional[Dict[str, Any]]): The current 3Dmol.js view object. If `None`, assumes a default initial view.
*   **Outputs:**
    *   `Dict[str, Any]`: An updated 3Dmol.js `viewObject` dictionary.
*   **Exceptions:**
    *   `ViewCalculationError`: If the rotation calculation fails due to invalid input.

### `compute_set_view(params: SetViewParams) -> Dict[str, Any]`

Returns the provided view object directly, intended for restoring a saved camera state.

*   **Inputs:**
    *   `params` (SetViewParams): A Pydantic object containing the `viewObject` to set.
*   **Outputs:**
    *   `Dict[str, Any]`: The `viewObject` provided in the input parameters.
*   **Exceptions:**
    *   `ValueError`: If the `viewObject` in parameters is malformed.

### `compute_translate_camera(params: TranslateCameraParams, current_view: Optional[Dict[str, Any]] = None) -> Dict[str, Any]`

Calculates the new camera position after translation (panning).

*   **Inputs:**
    *   `params` (TranslateCameraParams): A Pydantic object containing the translation `vector` [dx, dy, dz].
    *   `current_view` (Optional[Dict[str, Any]]): The current 3Dmol.js view object. If `None`, assumes a default initial view.
*   **Outputs:**
    *   `Dict[str, Any]`: An updated 3Dmol.js `viewObject` dictionary.
*   **Exceptions:**
    *   `ViewCalculationError`: If the translation calculation fails.

### `compute_zoom(params: ZoomParams, current_view: Optional[Dict[str, Any]] = None) -> Dict[str, Any]`

Calculates the new zoom level for the camera.

*   **Inputs:**
    *   `params` (ZoomParams): A Pydantic object containing the `factor` and optional `fixedPath`.
    *   `current_view` (Optional[Dict[str, Any]]): The current 3Dmol.js view object. If `None`, assumes a default initial view.
*   **Outputs:**
    *   `Dict[str, Any]`: An updated 3Dmol.js `viewObject` dictionary.
*   **Exceptions:**
    *   `ViewCalculationError`: If the zoom calculation fails.

### `compute_reset_view() -> Dict[str, Any]`

Returns a default 3Dmol.js view object, resetting the camera to its initial state.

*   **Inputs:** None
*   **Outputs:**
    *   `Dict[str, Any]`: A default 3Dmol.js `viewObject` dictionary.
*   **Exceptions:** None

---

## 6. Utilities (`utils/`)

The `utils/` directory contains helper modules that provide common functionalities across the backend service, such as error handling and logging.

### 6.1. Error Handlers (`utils/error_handlers.py`)

**Responsibility:**
The `error_handlers.py` module defines custom exception classes and functions for handling and formatting errors consistently across the application.

**Public Interface:**

### `handle_api_error(e: Exception) -> Response`

A Flask error handler that catches exceptions, logs them, and returns a standardized JSON error response to the client.

*   **Inputs:**
    *   `e` (Exception): The exception object caught by the Flask error handling mechanism.
*   **Outputs:**
    *   `Response`: A Flask `Response` object with a JSON body containing error details and an appropriate HTTP status code.
        ```json
        {
          "error": "string",
          "message": "string",
          "details": "string" // Optional, for debugging
        }
        ```
*   **Exceptions:** None (this function is an error handler itself)

**Custom Exception Classes:**
This module may define custom exception classes like:
*   `APIError(Exception)`: Base class for API-specific errors.
*   `InvalidInputError(APIError)`: For client-side input validation failures.
*   `ServiceUnavailableError(APIError)`: For issues with external services (e.g., OpenAI).
*   `InternalServerError(APIError)`: For unexpected backend errors.

---

### 6.2. Logging (`utils/logging.py`)

**Responsibility:**
The `logging.py` module configures the application's logging system, ensuring that messages are captured with appropriate severity levels and formats.

**Public Interface:**

### `setup_logging()`

Configures the Python `logging` module for the application. This function should be called once at application startup.

*   **Inputs:** None
*   **Outputs:** None
*   **Exceptions:** None
